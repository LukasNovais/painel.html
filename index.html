<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torre de Controle - Minha Frota</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; display: flex; height: 100vh; background: #f4f4f4; font-family: 'Segoe UI', Tahoma, sans-serif; }
        
        /* Barra Lateral */
        #sidebar { width: 320px; background: #1a1a1a; color: white; display: flex; flex-direction: column; z-index: 1000; box-shadow: 2px 0 10px rgba(0,0,0,0.5); }
        .header { padding: 20px; background: #111; border-bottom: 3px solid #1abc9c; text-align: center; }
        .header h2 { margin: 0; font-size: 1.1rem; color: #1abc9c; text-transform: uppercase; }
        
        #lista { flex-grow: 1; overflow-y: auto; padding: 10px; background: #222; }
        
        /* Itens da Lista */
        .veiculo-card { 
            background: #333; padding: 15px; margin-bottom: 10px; border-radius: 6px; 
            border-left: 5px solid #1abc9c; cursor: pointer; transition: 0.3s; 
        }
        .veiculo-card:hover { background: #444; transform: translateX(5px); }
        .veiculo-card b { display: block; font-size: 1rem; color: #fff; }
        .veiculo-card small { color: #aaa; display: block; margin-top: 4px; }
        .status-dot { color: #2ecc71; margin-right: 8px; font-size: 12px; }

        /* Mapa */
        #map { flex-grow: 1; background: #ddd; }
        
        /* Mensagens de Erro */
        .error-msg { color: #ff6b6b; padding: 15px; font-size: 0.9rem; line-height: 1.4; background: #2d1a1a; border-radius: 5px; margin: 10px; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="header">
        <h2>üöö Torre de Controle</h2>
    </div>
    <div id="lista">Sincronizando com Sigasat...</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // 1. Inicializa o mapa focado no Brasil
    const map = L.map('map').setView([-15.78, -47.92], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
    }).addTo(map);

    let marcadores = {};

    // 2. Fun√ß√£o de Busca de Dados (Ajustada para evitar Erro 500)
    async function atualizarDados() {
        try {
            // Criamos os par√¢metros que o servidor da Sigasat espera no corpo do POST
            const params = new URLSearchParams();
            params.append('page', '1');
            params.append('rows', '100');
            params.append('sort', 'dsc_veiculo');
            params.append('order', 'asc');

            const response = await fetch('https://srv.sigasat.com.br/dev/rast/index/grid.positions', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: params,
                credentials: 'include' // Usa os cookies do seu login ativo
            });

            // Lemos a resposta primeiro como texto para evitar erro de JSON caso venha erro 500
            const textoResposta = await response.text();
            
            let dados;
            try {
                dados = JSON.parse(textoResposta);
            } catch (e) {
                console.error("Servidor retornou erro ou p√°gina HTML em vez de dados:", textoResposta);
                document.getElementById('lista').innerHTML = `
                    <div class="error-msg">
                        <b>Erro 500: Resposta Inv√°lida</b><br>
                        O servidor da Sigasat n√£o entendeu o pedido. <br><br>
                        <b>Solu√ß√£o:</b> Atualize a p√°gina do site oficial da Sigasat e depois volte aqui.
                    </div>`;
                return;
            }

            const listaHtml = document.getElementById('lista');
            listaHtml.innerHTML = ''; 

            if (!dados.rows || dados.rows.length === 0) {
                listaHtml.innerHTML = '<div class="error-msg">Nenhum ve√≠culo encontrado na conta.</div>';
                return;
            }

            dados.rows.forEach(veiculo => {
                // Tentativa de mapear campos comuns (latitude, lat_veiculo, etc)
                const lat = parseFloat(veiculo.latitude || veiculo.lat_veiculo);
                const lng = parseFloat(veiculo.longitude || veiculo.lng_veiculo);
                const placa = veiculo.placa || veiculo.dsc_veiculo || "Sem Placa";
                const dsc = veiculo.dsc_veiculo || "";

                if (!isNaN(lat) && !isNaN(lng)) {
                    // Atualiza ou cria o marcador no mapa
                    if (marcadores[placa]) {
                        marcadores[placa].setLatLng([lat, lng]);
                    } else {
                        marcadores[placa] = L.marker([lat, lng])
                            .addTo(map)
                            .bindPopup(`<b>${placa}</b><br>${dsc}`);
                    }

                    // Adiciona na lista lateral
                    listaHtml.innerHTML += `
                        <div class="veiculo-card" onclick="focarVeiculo(${lat}, ${lng}, '${placa}')">
                            <b><span class="status-dot">‚óè</span>${placa}</b>
                            <small>${dsc}</small>
                        </div>`;
                }
            });

        } catch (erro) {
            console.error("Erro na requisi√ß√£o:", erro);
            document.getElementById('lista').innerHTML = `
                <div class="error-msg">
                    <b>Erro de Conex√£o</b><br>
                    Certifique-se que a extens√£o <b>Allow CORS</b> est√° ativa e verde.
                </div>`;
        }
    }

    // 3. Centraliza o mapa ao clicar no ve√≠culo
    function focarVeiculo(lat, lng, placa) {
        map.setView([lat, lng], 16);
        if (marcadores[placa]) {
            marcadores[placa].openPopup();
        }
    }

    // Inicia e agenda atualiza√ß√£o (30 em 30 segundos)
    atualizarDados();
    setInterval(atualizarDados, 30000);

</script>
</body>
</html>
