<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Painel Unificado - Minha Frota</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: sans-serif; }
        #map { flex-grow: 1; height: 100%; }
        #sidebar { width: 300px; background: #1a1a1a; color: white; padding: 15px; overflow-y: auto; }
        .veiculo { border-bottom: 1px solid #333; padding: 10px 0; font-size: 14px; }
        .status-on { color: #2ecc71; } /* Verde */
        h2 { color: #1abc9c; font-size: 18px; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>üöö Monitoramento</h2>
    <div id="lista">Buscando dados da Sigasat...</div>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. Configurar o Mapa
    const map = L.map('map').setView([-15.78, -47.92], 4); 
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    
    let marcadores = {};

    async function atualizarDados() {
        try {
            // 2. Tentar buscar os dados da Sigasat usando o link que descobrimos
            const response = await fetch('https://srv.sigasat.com.br/dev/rast/index/grid.positions');
            const dados = await response.json();
            
            const listaHtml = document.getElementById('lista');
            listaHtml.innerHTML = ''; // Limpa a lista para atualizar

            // 3. Processar cada caminh√£o (ajustado para o formato prov√°vel da Sigasat)
            dados.rows.forEach(veiculo => {
                const { placa, latitude, longitude, dsc_veiculo } = veiculo;

                // Adicionar ou atualizar marcador no mapa
                if (latitude && longitude) {
                    if (marcadores[placa]) {
                        marcadores[placa].setLatLng([latitude, longitude]);
                    } else {
                        marcadores[placa] = L.marker([latitude, longitude])
                            .addTo(map)
                            .bindPopup(`<b>${placa}</b><br>${dsc_veiculo}`);
                    }
                }

                // Adicionar na lista lateral
                listaHtml.innerHTML += `
                    <div class="veiculo">
                        <span class="status-on">‚óè</span> <b>${placa}</b><br>
                        <small>${dsc_veiculo}</small>
                    </div>`;
            });

        } catch (erro) {
            console.error("Erro ao buscar dados:", erro);
            document.getElementById('lista').innerHTML = "Erro ao conectar. Verifique se voc√™ est√° logado no site da Sigasat em outra aba.";
        }
    }

    // Atualiza a cada 30 segundos
    atualizarDados();
    setInterval(atualizarDados, 30000);
</script>
</body>
</html>
