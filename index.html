<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torre de Controle - Minha Frota</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; display: flex; height: 100vh; background: #f4f4f4; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Barra Lateral */
        #sidebar { width: 320px; background: #222; color: white; display: flex; flex-direction: column; box-shadow: 2px 0 5px rgba(0,0,0,0.3); z-index: 1000; }
        .header { padding: 20px; background: #1a1a1a; border-bottom: 2px solid #1abc9c; text-align: center; }
        .header h2 { margin: 0; font-size: 1.2rem; color: #1abc9c; }
        
        #lista { flex-grow: 1; overflow-y: auto; padding: 10px; }
        
        /* Estilo dos itens da lista */
        .veiculo-card { background: #333; padding: 12px; margin-bottom: 8px; border-radius: 4px; border-left: 4px solid #1abc9c; cursor: pointer; transition: 0.2s; }
        .veiculo-card:hover { background: #444; }
        .veiculo-card b { display: block; font-size: 1rem; margin-bottom: 4px; }
        .status-dot { color: #2ecc71; margin-right: 5px; }

        /* Mapa */
        #map { flex-grow: 1; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="header">
        <h2>üöö MONITORAMENTO REAL-TIME</h2>
    </div>
    <div id="lista">Conectando √† Sigasat...</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // Inicializa o mapa focado no Brasil
    const map = L.map('map').setView([-15.78, -47.92], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
    }).addTo(map);

    let marcadores = {};

    async function atualizarDados() {
        try {
            // Chamada para a API da Sigasat que voc√™ descobriu
            const response = await fetch('https://srv.sigasat.com.br/dev/rast/index/grid.positions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'page=1&rows=100' // Ajuste o 'rows' se tiver mais de 100 ve√≠culos
            });

            if (!response.ok) throw new Error('Falha na resposta do servidor');
            
            const dados = await response.json();
            const listaHtml = document.getElementById('lista');
            listaHtml.innerHTML = ''; 

            dados.rows.forEach(veiculo => {
                // Mapeando os dados (ajuste os nomes se necess√°rio conforme o JSON da Sigasat)
                const lat = parseFloat(veiculo.latitude);
                const lng = parseFloat(veiculo.longitude);
                const placa = veiculo.placa || 'Sem Placa';
                const dsc = veiculo.dsc_veiculo || '';

                if (!isNaN(lat) && !isNaN(lng)) {
                    // Atualiza ou Cria marcador no mapa
                    if (marcadores[placa]) {
                        marcadores[placa].setLatLng([lat, lng]);
                    } else {
                        marcadores[placa] = L.marker([lat, lng])
                            .addTo(map)
                            .bindPopup(`<b>${placa}</b><br>${dsc}`);
                    }

                    // Adiciona na lista lateral
                    listaHtml.innerHTML += `
                        <div class="veiculo-card" onclick="focarVeiculo(${lat}, ${lng}, '${placa}')">
                            <b><span class="status-dot">‚óè</span>${placa}</b>
                            <small>${dsc}</small>
                        </div>`;
                }
            });

        } catch (erro) {
            console.error("Erro detalhado:", erro);
            document.getElementById('lista').innerHTML = `
                <div style="color: #ff6b6b; padding: 10px;">
                    <b>Erro de Conex√£o:</b><br>
                    1. Verifique se est√° logado no site da Sigasat.<br>
                    2. Certifique-se que a extens√£o <b>Allow CORS</b> est√° ATIVA.
                </div>`;
        }
    }

    // Fun√ß√£o para clicar na lista e o mapa ir at√© o caminh√£o
    function focarVeiculo(lat, lng, placa) {
        map.setView([lat, lng], 15);
        marcadores[placa].openPopup();
    }

    // Executa agora e depois a cada 30 segundos
    atualizarDados();
    setInterval(atualizarDados, 30000);

</script>
</body>
</html>
