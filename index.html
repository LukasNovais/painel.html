<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torre de Controle - Sigasat</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; display: flex; height: 100vh; background: #f4f4f4; font-family: 'Segoe UI', sans-serif; }
        
        #sidebar { width: 320px; background: #1a1a1a; color: white; display: flex; flex-direction: column; z-index: 1000; box-shadow: 2px 0 10px rgba(0,0,0,0.5); }
        .header { padding: 20px; background: #111; border-bottom: 3px solid #1abc9c; text-align: center; }
        .header h2 { margin: 0; font-size: 1.1rem; color: #1abc9c; letter-spacing: 1px; }
        
        #lista { flex-grow: 1; overflow-y: auto; padding: 10px; background: #222; }
        
        .veiculo-card { 
            background: #333; padding: 15px; margin-bottom: 10px; border-radius: 6px; 
            border-left: 5px solid #1abc9c; cursor: pointer; transition: 0.3s; 
        }
        .veiculo-card:hover { background: #444; transform: translateX(5px); }
        .veiculo-card b { display: block; font-size: 1rem; color: #fff; }
        .veiculo-card small { color: #aaa; }
        .status-dot { color: #2ecc71; margin-right: 8px; font-size: 12px; }

        #map { flex-grow: 1; background: #ddd; }
        
        .error-msg { color: #ff6b6b; padding: 15px; font-size: 0.9rem; line-height: 1.4; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="header">
        <h2>üöö PAINEL DE MONITORAMENTO</h2>
    </div>
    <div id="lista">Iniciando conex√£o...</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // 1. Configura√ß√£o Inicial do Mapa
    const map = L.map('map').setView([-15.78, -47.92], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    let marcadores = {};

    // 2. Fun√ß√£o Principal de Busca de Dados
    async function atualizarDados() {
        try {
            const response = await fetch('https://srv.sigasat.com.br/dev/rast/index/grid.positions', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: 'page=1&rows=100', // Puxa os primeiros 100 ve√≠culos
                credentials: 'include'   // Usa seus cookies de login do Chrome
            });

            if (!response.ok) throw new Error('Acesso negado ou servidor fora do ar');
            
            const dados = await response.json();
            
            // Verifica se o servidor retornou a lista de ve√≠culos
            if (!dados || !dados.rows) {
                document.getElementById('lista').innerHTML = `
                    <div class="error-msg">
                        <b>Sess√£o expirada!</b><br>
                        Acesse o site da Sigasat em outra aba, fa√ßa login e depois atualize esta p√°gina.
                    </div>`;
                return;
            }

            const listaHtml = document.getElementById('lista');
            listaHtml.innerHTML = ''; 

            dados.rows.forEach(veiculo => {
                // Mapeia coordenadas (tenta diferentes nomes de campos comuns na Sigasat)
                const lat = parseFloat(veiculo.latitude || veiculo.lat_veiculo || veiculo.lat);
                const lng = parseFloat(veiculo.longitude || veiculo.lng_veiculo || veiculo.lng);
                const placa = veiculo.placa || veiculo.dsc_veiculo || 'ID: ' + veiculo.cd_veiculo;
                const dsc = veiculo.dsc_veiculo || '';

                if (!isNaN(lat) && !isNaN(lng)) {
                    // Atualiza marcador no mapa
                    if (marcadores[placa]) {
                        marcadores[placa].setLatLng([lat, lng]);
                    } else {
                        marcadores[placa] = L.marker([lat, lng])
                            .addTo(map)
                            .bindPopup(`<b>Ve√≠culo:</b> ${placa}<br><b>Status:</b> Online`);
                    }

                    // Adiciona na lista lateral
                    listaHtml.innerHTML += `
                        <div class="veiculo-card" onclick="focarVeiculo(${lat}, ${lng}, '${placa}')">
                            <b><span class="status-dot">‚óè</span>${placa}</b>
                            <small>${dsc}</small>
                        </div>`;
                }
            });

        } catch (erro) {
            console.error("Erro no Monitoramento:", erro);
            document.getElementById('lista').innerHTML = `
                <div class="error-msg">
                    <b>Erro de Conex√£o</b><br>
                    1. Verifique a extens√£o <b>Allow CORS</b> (deve estar ON).<br>
                    2. Mantenha o site da Sigasat logado em outra aba.
                </div>`;
        }
    }

    // 3. Fun√ß√£o para centralizar no caminh√£o ao clicar na lista
    function focarVeiculo(lat, lng, placa) {
        map.setView([lat, lng], 16); // D√° zoom no ve√≠culo
        if (marcadores[placa]) {
            marcadores[placa].openPopup();
        }
    }

    // Inicia a atualiza√ß√£o e define intervalo (30 segundos)
    atualizarDados();
    setInterval(atualizarDados, 30000);

</script>
</body>
</html>
